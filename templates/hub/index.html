{% extends "base.html" %}
{% block title %}Dashboard · RoutineUp{% endblock %}

{% block content %}
<div class="hub-premium">
  
  <!-- Hero Header -->
  <div class="hero-header">
    <div class="hero-content">
      <div class="greeting-wrapper">
        <h1 class="hero-greeting">{{ greeting }}, {{ first_name(current_user) }}! 👋</h1>
        <p class="hero-date">{{ today_formatted }}</p>
      </div>
      
      <!-- Score Circle Premium -->
      <div class="score-premium">
        <div class="score-ring">
          <svg width="100" height="100" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="score-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8B5CF6"/>
                <stop offset="50%" style="stop-color:#6366f1"/>
                <stop offset="100%" style="stop-color:#4F46E5"/>
              </linearGradient>
              <filter id="glow">
                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(99, 102, 241, 0.1)" stroke-width="8"></circle>
            <circle cx="50" cy="50" r="42" fill="none" stroke="url(#score-gradient)" stroke-width="8"
                    stroke-dasharray="{{ 2 * 3.14159 * 42 }}"
                    stroke-dashoffset="{{ 2 * 3.14159 * 42 * (1 - stats.productivity_score / 100) }}"
                    stroke-linecap="round"
                    transform="rotate(-90 50 50)"
                    filter="url(#glow)"></circle>
          </svg>
          <div class="score-content">
            <span class="score-number">{{ stats.productivity_score }}</span>
            <span class="score-label">Score</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
      <a href="{{ url_for('tasks.index') }}" class="quick-btn">
        <i data-feather="plus-circle"></i>
        <span>Nova Tarefa</span>
      </a>
      <a href="{{ url_for('goals.index') }}" class="quick-btn">
        <i data-feather="target"></i>
        <span>Nova Meta</span>
      </a>
      <a href="{{ url_for('reminders.index') }}" class="quick-btn">
        <i data-feather="bell"></i>
        <span>Lembrete</span>
      </a>
    </div>
  </div>

  <!-- Stats Grid Premium -->
  <div class="stats-premium">
    <div class="stat-box stat-today">
      <div class="stat-header">
        <div class="stat-icon-circle">
          <i data-feather="check-circle"></i>
        </div>
        <span class="stat-trend">+{{ stats.tasks_completed_today }}</span>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.tasks_completed_today }}</div>
        <div class="stat-text">Concluídas Hoje</div>
      </div>
      <div class="stat-footer">
        <div class="stat-mini-chart">
          <span style="height: 40%"></span>
          <span style="height: 70%"></span>
          <span style="height: 50%"></span>
          <span style="height: 85%"></span>
          <span style="height: 100%"></span>
        </div>
      </div>
    </div>

    <div class="stat-box stat-pending">
      <div class="stat-header">
        <div class="stat-icon-circle">
          <i data-feather="clock"></i>
        </div>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.pending_total }}</div>
        <div class="stat-text">Pendentes</div>
      </div>
      <div class="stat-progress">
        <div class="progress-mini" style="width: {{ 100 - stats.completion_rate }}%"></div>
      </div>
    </div>

    <div class="stat-box stat-streak">
      <div class="stat-header">
        <div class="stat-icon-circle stat-fire">
          <span class="fire-emoji">🔥</span>
        </div>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.streak }}</div>
        <div class="stat-text">Dias Seguidos</div>
      </div>
      <div class="streak-badges">
        {% set display_streak = stats.streak if stats.streak <= 7 else 7 %}
        {% for i in range(display_streak) %}
        <span class="streak-dot active"></span>
        {% endfor %}
        {% for i in range(7 - display_streak) %}
        <span class="streak-dot"></span>
        {% endfor %}
      </div>
    </div>

    <div class="stat-box stat-rate">
      <div class="stat-header">
        <div class="stat-icon-circle">
          <i data-feather="trending-up"></i>
        </div>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.completion_rate }}%</div>
        <div class="stat-text">Taxa de Conclusão</div>
      </div>
      <div class="circular-progress" style="--progress: {{ stats.completion_rate }}%">
        <svg width="60" height="60">
          <circle cx="30" cy="30" r="26" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"></circle>
          <circle cx="30" cy="30" r="26" fill="none" stroke="#10b981" stroke-width="4"
                  stroke-dasharray="163.36" 
                  stroke-dashoffset="{{ 163.36 * (1 - stats.completion_rate / 100) }}"
                  transform="rotate(-90 30 30)"></circle>
        </svg>
      </div>
    </div>

    {% if stats.overdue_tasks > 0 %}
    <div class="stat-box stat-overdue">
      <div class="stat-header">
        <div class="stat-icon-circle stat-alert">
          <i data-feather="alert-circle"></i>
        </div>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.overdue_tasks }}</div>
        <div class="stat-text">Atrasadas</div>
      </div>
      <a href="{{ url_for('tasks.index', filter='pending', sort='due_date') }}" class="stat-action">
      </a>
    </div>
    {% endif %}

    <div class="stat-box stat-goals">
      <div class="stat-header">
        <div class="stat-icon-circle">
          <i data-feather="target"></i>
        </div>
      </div>
      <div class="stat-body">
        <div class="stat-number">{{ stats.active_goals }}</div>
        <div class="stat-text">Metas Ativas</div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">
    
    <!-- Chart Section -->
    <div class="chart-section">
      
      <!-- Agenda - DESTAQUE PRINCIPAL -->
      <div class="premium-card agenda-card agenda-highlight">
        <div class="card-header-premium">
          <i data-feather="calendar" class="header-icon"></i>
          <div>
            <h3 class="card-title-premium"> Agenda de Hoje</h3>
            <p class="card-subtitle">{{ timeline_items|length }} compromisso(s) agendado(s)</p>
          </div>
        </div>
        
        {% if timeline_items %}
        <div class="timeline-premium">
          {% for item in timeline_items %}
          <div class="timeline-entry">
            <div class="timeline-marker {{ item.type }}">
              <i data-feather="{{ 'check-square' if item.type == 'task' else 'bell' }}"></i>
            </div>
            <div class="timeline-time">{{ item.time.strftime('%H:%M') }}</div>
            <div class="timeline-detail">
              {% if item.type == 'task' %}
                <span class="priority-dot priority-{{ item.obj.priority }}"></span>
                <a href="{{ url_for('tasks.edit', task_id=item.obj.id) }}" class="timeline-title">{{ item.obj.title }}</a>
              {% else %}
                <span class="timeline-title">{{ item.obj.title }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state-premium">
          <div class="empty-icon">☕</div>
          <h4>Dia Livre!</h4>
          <p>Nenhum compromisso agendado para hoje</p>
        </div>
        {% endif %}
      </div>
      
      <!-- Atividade Semanal -->
      <div class="premium-card">
        <div class="card-header-premium">
          <div class="header-left">
            <i data-feather="bar-chart-2" class="header-icon"></i>
            <div>
              <h3 class="card-title-premium">Atividade Semanal</h3>
              <p class="card-subtitle">Últimos 7 dias</p>
            </div>
          </div>
          <div class="card-legend">
            <span class="legend-item"><span class="legend-dot completed"></span>Concluídas</span>
            <span class="legend-item"><span class="legend-dot created"></span>Criadas</span>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <!-- Priority Distribution -->
      <div class="premium-card priority-card">
        <div class="card-header-premium">
          <i data-feather="pie-chart" class="header-icon"></i>
          <div>
            <h3 class="card-title-premium">Distribuição por Prioridade</h3>
            <p class="card-subtitle">Tarefas pendentes</p>
          </div>
        </div>
        <div class="priority-list-premium">
          {% set total = stats.priority_distribution.low + stats.priority_distribution.medium + stats.priority_distribution.high %}
          
          <div class="priority-row-premium">
            <div class="priority-info">
              <span class="priority-badge high">Alta</span>
              <span class="priority-percent">{{ ((stats.priority_distribution.high / total * 100) if total > 0 else 0)|round|int }}%</span>
            </div>
            <div class="priority-bar-container">
              <div class="priority-bar-animated high" style="width: {{ (stats.priority_distribution.high / total * 100) if total > 0 else 0 }}%"></div>
            </div>
            <span class="priority-value">{{ stats.priority_distribution.high }}</span>
          </div>

          <div class="priority-row-premium">
            <div class="priority-info">
              <span class="priority-badge medium">Média</span>
              <span class="priority-percent">{{ ((stats.priority_distribution.medium / total * 100) if total > 0 else 0)|round|int }}%</span>
            </div>
            <div class="priority-bar-container">
              <div class="priority-bar-animated medium" style="width: {{ (stats.priority_distribution.medium / total * 100) if total > 0 else 0 }}%"></div>
            </div>
            <span class="priority-value">{{ stats.priority_distribution.medium }}</span>
          </div>

          <div class="priority-row-premium">
            <div class="priority-info">
              <span class="priority-badge low">Baixa</span>
              <span class="priority-percent">{{ ((stats.priority_distribution.low / total * 100) if total > 0 else 0)|round|int }}%</span>
            </div>
            <div class="priority-bar-container">
              <div class="priority-bar-animated low" style="width: {{ (stats.priority_distribution.low / total * 100) if total > 0 else 0 }}%"></div>
            </div>
            <span class="priority-value">{{ stats.priority_distribution.low }}</span>
          </div>

          {% if total == 0 %}
          <div class="empty-state-mini">
            <span>🎉</span>
            <p>Nenhuma tarefa pendente!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Timeline & Sidebar -->
    <div class="timeline-section">
      
      <!-- Overdue Tasks -->
      {% if atrasadas %}
      <div class="premium-card alert-card-premium">
        <div class="card-header-premium">
          <i data-feather="alert-triangle" class="header-icon alert"></i>
          <div>
            <h3 class="card-title-premium">Tarefas Atrasadas</h3>
            <p class="card-subtitle">{{ atrasadas|length }} tarefa(s)</p>
          </div>
        </div>
        <div class="overdue-list">
          {% for task in atrasadas[:5] %}
          <div class="overdue-item">
            <span class="priority-dot priority-{{ task.priority }}"></span>
            <a href="{{ url_for('tasks.edit', task_id=task.id) }}" class="overdue-title">{{ task.title }}</a>
            <span class="overdue-date">{{ task.due_date.strftime('%d/%m') }}</span>
          </div>
          {% endfor %}
        </div>
        {% if atrasadas|length > 5 %}
        <a href="{{ url_for('tasks.index', filter='pending') }}" class="card-footer-link">
          Ver todas ({{ atrasadas|length }}) →
        </a>
        {% endif %}
      </div>
      {% endif %}

      <!-- Goals -->
      {% if metas %}
      <div class="premium-card goals-card">
        <div class="card-header-premium">
          <i data-feather="target" class="header-icon"></i>
          <div>
            <h3 class="card-title-premium">Metas Recentes</h3>
            <p class="card-subtitle">{{ metas|length }} ativa(s)</p>
          </div>
        </div>
        <div class="goals-list-premium">
          {% for goal in metas %}
          <div class="goal-item-premium">
            <div class="goal-header-flex">
              <span class="goal-title-premium">{{ goal.title }}</span>
              <span class="goal-percentage">{{ goal.progress }}%</span>
            </div>
            <div class="goal-progress-premium">
              <div class="goal-fill" style="width: {{ goal.progress }}%"></div>
            </div>
          </div>
          {% endfor %}
        </div>
        <a href="{{ url_for('goals.index') }}" class="card-footer-link">
          Ver todas →
        </a>
      </div>
      {% endif %}

    </div>

  </div>

</div>

<style>
/* Destaque especial para a agenda */
.agenda-highlight {
  border: 2px solid rgba(139, 92, 246, 0.3);
  box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15), 0 0 0 1px rgba(139, 92, 246, 0.1);
  position: relative;
  overflow: hidden;
}

.agenda-highlight::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #8B5CF6, #6366f1, #4F46E5);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.agenda-highlight .card-title-premium {
  font-size: 1.25rem;
  background: linear-gradient(135deg, #8B5CF6, #6366f1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Melhorias nos itens da timeline */
.timeline-entry {
  transition: all 0.3s ease;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.timeline-entry:hover {
  background: rgba(139, 92, 246, 0.05);
  transform: translateX(4px);
}

.timeline-marker {
  transition: all 0.3s ease;
}

.timeline-entry:hover .timeline-marker {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.timeline-time {
  font-weight: 700;
  color: #8B5CF6;
  font-size: 0.9rem;
}

/* Animação suave no carregamento */
.agenda-highlight {
  animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const weeklyData = {{ stats.weekly_chart | tojson }};
  
  const ctx = document.getElementById('weeklyChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weeklyData.map(d => d.day),
        datasets: [
          {
            label: 'Concluídas',
            data: weeklyData.map(d => d.completed),
            backgroundColor: (context) => {
              const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
              gradient.addColorStop(0, 'rgba(139, 92, 246, 0.8)');
              gradient.addColorStop(1, 'rgba(139, 92, 246, 0.3)');
              return gradient;
            },
            borderColor: '#8B5CF6',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false
          },
          {
            label: 'Criadas',
            data: weeklyData.map(d => d.created),
            backgroundColor: (context) => {
              const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
              gradient.addColorStop(0, 'rgba(79, 70, 229, 0.6)');
              gradient.addColorStop(1, 'rgba(79, 70, 229, 0.2)');
              return gradient;
            },
            borderColor: '#4F46E5',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 16,
            borderRadius: 12,
            borderColor: 'rgba(139, 92, 246, 0.5)',
            borderWidth: 2,
            titleColor: '#e5e7eb',
            bodyColor: '#e5e7eb',
            titleFont: { size: 14, weight: '700' },
            bodyFont: { size: 13 },
            displayColors: true,
            boxWidth: 12,
            boxHeight: 12,
            boxPadding: 6
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              color: '#64748b',
              font: { size: 11, weight: '600' }
            },
            grid: {
              color: 'rgba(99, 102, 241, 0.08)',
              drawBorder: false
            },
            border: {
              display: false
            }
          },
          x: {
            ticks: {
              color: '#94a3b8',
              font: { size: 11, weight: '600' }
            },
            grid: {
              display: false
            },
            border: {
              display: false
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        }
      }
    });
  }

  feather.replace();

  // Animação de contadores
  document.querySelectorAll('.stat-number').forEach(el => {
    const target = parseInt(el.textContent);
    if (isNaN(target)) return;
    
    let current = 0;
    const increment = target / 50;
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        el.textContent = target + (el.textContent.includes('%') ? '%' : '');
        clearInterval(timer);
      } else {
        el.textContent = Math.floor(current) + (el.textContent.includes('%') ? '%' : '');
      }
    }, 20);
  });
</script>
{% endblock %}